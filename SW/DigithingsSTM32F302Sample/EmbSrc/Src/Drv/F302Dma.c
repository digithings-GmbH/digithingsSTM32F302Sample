#include "../Target/Target.h"
#include "../STM32F302_Gen/STM32F302_DMA1_CH7_Def.h"
#include "../STM32F302_Gen/STM32F302_ADC1_Def.h"
#include "../STM32F302_Gen/STM32F302_ADC1_2_Def.h"
#include "../STM32F302_Gen/STM32F302_TIM2_Def.h"
#include "../HalOut/NeoPixel.h"

#define DMA_CHANNEL_0 0

unsigned long DmaAdc[4];

unsigned long DmaGetValueAdc(unsigned char Chn) {
	return DmaAdc[Chn];
}

void F302DmaInitCh1 (void) {
	volatile sSTM32F302_DMA1_CH7* pSTM32F302_DMA1_CH7 = (sSTM32F302_DMA1_CH7*)F302_DMA1_7_ADR;
	volatile sSTM32F302_ADC1* pSTM32F302_ADC1 = (sSTM32F302_ADC1*)F302_ADC1_ADR;

	volatile uSTM32F302_DMA1_CH7_CCR1 STM32F302_DMA1_CH7_CCR1;
	volatile uSTM32F302_DMA1_CH7_CNDTR1 STM32F302_DMA1_CH7_CNDTR1;

	DmaAdc[0] = 0;
	DmaAdc[1] = 0;
	DmaAdc[2] = 0;
	DmaAdc[3] = 0;

	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CPAR1.All  = (unsigned long)&pSTM32F302_ADC1->STM32F302_ADC1_DR.All;
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CMAR1.All = (unsigned long)&DmaAdc;

	STM32F302_DMA1_CH7_CNDTR1.All = 0;
	STM32F302_DMA1_CH7_CNDTR1.Bit.NDT = 2;
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CNDTR1.All = STM32F302_DMA1_CH7_CNDTR1.All;

	STM32F302_DMA1_CH7_CCR1.All = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.MEM2MEM = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.PL = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.MSIZE = 2;
	STM32F302_DMA1_CH7_CCR1.Bit.PSIZE = 2;
	STM32F302_DMA1_CH7_CCR1.Bit.MINC = 1;
	STM32F302_DMA1_CH7_CCR1.Bit.PINC = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.DIR = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.CIRC = 1;
	STM32F302_DMA1_CH7_CCR1.Bit.TCIE = 0;
	STM32F302_DMA1_CH7_CCR1.Bit.EN = 1;
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CCR1.All = STM32F302_DMA1_CH7_CCR1.All;
}

void F302DmaInitCh5 (void) {

	volatile sSTM32F302_DMA1_CH7* pSTM32F302_DMA1_CH7 = (sSTM32F302_DMA1_CH7*)F302_DMA1_7_ADR;
	volatile sSTM32F302_TIM2* pSTM32F302_TIM2 = (sSTM32F302_TIM2*)F302_TIM2_ADR;

	volatile uSTM32F302_DMA1_CH7_CCR5 STM32F302_DMA1_CH7_CCR5;
	volatile uSTM32F302_DMA1_CH7_CNDTR5 STM32F302_DMA1_CH7_CNDTR5;

	uNeoPixelProtocol * pDmaNeoPixelProtocol;
	pDmaNeoPixelProtocol = pNeoPixelGetProtocolData();

	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CPAR5.Bit.PA = (unsigned long)&pSTM32F302_TIM2->STM32F302_TIM2_CCR1.All;
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CMAR5.Bit.MA = (unsigned long)(pDmaNeoPixelProtocol);

	STM32F302_DMA1_CH7_CNDTR5.All = 0;
	STM32F302_DMA1_CH7_CNDTR5.Bit.NDT = (NEOPIXEL_DATA_SIZE_RAW+NEO_PIXEL_TIME_RESET);
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CNDTR5.All = STM32F302_DMA1_CH7_CNDTR5.All;

	STM32F302_DMA1_CH7_CCR5.All = 0;
	STM32F302_DMA1_CH7_CCR5.Bit.MEM2MEM = 0;
	STM32F302_DMA1_CH7_CCR5.Bit.PL = 0;
	STM32F302_DMA1_CH7_CCR5.Bit.MSIZE = 0;
	STM32F302_DMA1_CH7_CCR5.Bit.PSIZE = 2;
	STM32F302_DMA1_CH7_CCR5.Bit.MINC = 1;
	STM32F302_DMA1_CH7_CCR5.Bit.PINC = 0;
	STM32F302_DMA1_CH7_CCR5.Bit.DIR = 1;
	STM32F302_DMA1_CH7_CCR5.Bit.CIRC= 1;
	STM32F302_DMA1_CH7_CCR5.Bit.TCIE= 0;
	STM32F302_DMA1_CH7_CCR5.Bit.EN = 1;
	pSTM32F302_DMA1_CH7->STM32F302_DMA1_CH7_CCR5.All = STM32F302_DMA1_CH7_CCR5.All;
}

void F302DmaMain(void) {
#if 0 /* Only for debug reason to find out if dma works */
	volatile sSTM32F302_DMA1_CH7* pSTM32F302_DMA1_CH7 = (sSTM32F302_DMA1_CH7*)F302_DMA1_7_ADR;
	volatile sSTM32F302_ADC1* pSTM32F302_ADC1 = (sSTM32F302_ADC1*)F302_ADC1_ADR;
	volatile sSTM32F302_ADC1_2* pSTM32F302_ADC1_2 = (sSTM32F302_ADC1_2*)(F302_ADC12_ADR);
	ASM("NOP");
#endif
}
