#include "..\Target\Target.h"
#include "..\STM32F302_Gen\STM32F302_RCC_Def.h"

#define RCC_HSI_OSC_8000000 8000000

#define RCC_PLLSRC_NO_CLOCK_00 0
#define RCC_PLLSRC_NO_CLOCK_01 1
#define RCC_PLLSRC_HSI16_02 2
#define RCC_PLLSRC_HSE_03 3


#define RCC_CFGR_SW_HSI16 1
#define RCC_CFGR_SW_HSE 2
#define RCC_CFGR_SW_PLL 3

void F302RccPllInit(void) {
	volatile sSTM32F302_RCC* pSTM32F302_RCC = (sSTM32F302_RCC*)F302_RCC_ADR;
	volatile uSTM32F302_RCC_CR STM32F302_RCC_CR;
	volatile uSTM32F302_RCC_CFGR STM32F302_RCC_CFGR;

	while(1 != pSTM32F302_RCC->STM32F302_RCC_CR.Bit.HSIRDY){
		//asm("NOP");
	}

	STM32F302_RCC_CFGR.All = 0;
	STM32F302_RCC_CFGR.Bit.PLLMUL = 0xA; /* 4 * 12 = 48 MHz */
	STM32F302_RCC_CFGR.Bit.PLLSRC = 0; /* HSI div 2 = 4MHz */
	pSTM32F302_RCC->STM32F302_RCC_CFGR.All = STM32F302_RCC_CFGR.All;

	STM32F302_RCC_CR.All = pSTM32F302_RCC->STM32F302_RCC_CR.All;
	STM32F302_RCC_CR.Bit.PLLON = 1;
	pSTM32F302_RCC->STM32F302_RCC_CR.All = STM32F302_RCC_CR.All;

	while(1 != pSTM32F302_RCC->STM32F302_RCC_CR.Bit.PLLRDY){
		ASM("NOP");
	}

	STM32F302_RCC_CFGR.All = pSTM32F302_RCC->STM32F302_RCC_CFGR.All;
	STM32F302_RCC_CFGR.Bit.SW = 2;
	STM32F302_RCC_CFGR.Bit.MCO = 4;
	pSTM32F302_RCC->STM32F302_RCC_CFGR.All = STM32F302_RCC_CFGR.All;
}


void F302RccInit(void)
{
	F302RccPllInit();

	volatile sSTM32F302_RCC* pSTM32F302_RCC = (sSTM32F302_RCC*)F302_RCC_ADR;
	volatile uSTM32F302_RCC_AHBENR STM32F302_RCC_AHBENR;
	volatile uSTM32F302_RCC_APB1ENR STM32F302_RCC_APB1ENR;
	volatile uSTM32F302_RCC_APB2ENR STM32F302_RCC_APB2ENR;

	STM32F302_RCC_AHBENR.All = 0;			// Reset value: 0x0000 0000
	STM32F302_RCC_AHBENR.Bit.IOPAEN = 1;
	STM32F302_RCC_AHBENR.Bit.IOPBEN = 1;
	STM32F302_RCC_AHBENR.Bit.IOPCEN = 1;
	STM32F302_RCC_AHBENR.Bit.ADC12EN = 1;
	STM32F302_RCC_AHBENR.Bit.DMAEN = 1;
	pSTM32F302_RCC->STM32F302_RCC_AHBENR.All = STM32F302_RCC_AHBENR.All;

	STM32F302_RCC_APB1ENR.All = 0;			// Reset value: 0x0000 0000
	STM32F302_RCC_APB1ENR.Bit.TIM2EN = 1;
	STM32F302_RCC_APB1ENR.Bit.SPI3EN = 1;
	pSTM32F302_RCC->STM32F302_RCC_APB1ENR.All = STM32F302_RCC_APB1ENR.All;

	STM32F302_RCC_APB2ENR.All = 0;			// Reset value: 0x0000 0000
	STM32F302_RCC_APB2ENR.Bit.USART1EN = 1;
	pSTM32F302_RCC->STM32F302_RCC_APB2ENR.All = STM32F302_RCC_APB2ENR.All;
}
