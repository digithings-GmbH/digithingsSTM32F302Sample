#include "../Target/Target.h"
#include "../STM32F302_Gen/STM32F302_ADC1_Def.h"
#include "../STM32F302_Gen/STM32F302_ADC1_2_Def.h"

void F302AdcInit(void) {
	volatile sSTM32F302_ADC1* pSTM32F302_ADC1 = (sSTM32F302_ADC1*)F302_ADC1_ADR;
	volatile sSTM32F302_ADC1_2* pSTM32F302_ADC1_2 = (sSTM32F302_ADC1_2*)(F302_ADC12_ADR);
	volatile uSTM32F302_ADC1_SMPR1 STM32F302_ADC1_SMPR1;

	//volatile uSTM32F302_ADC1_ADC1_ISR AdcIsr;
	volatile uSTM32F302_ADC1_SQR1 STM32F302_ADC1_SQR1;
	volatile uSTM32F302_ADC1_SQR2 STM32F302_ADC1_SQR2;
	volatile uSTM32F302_ADC1_CR STM32F302_ADC1_CR;
	volatile uSTM32F302_ADC1_CFGR STM32F302_ADC1_CFGR;
	volatile uSTM32F302_ADC1_2_CCR STM32F302_ADC1_2_CCR;

	unsigned long i;

	STM32F302_ADC1_2_CCR.All = pSTM32F302_ADC1_2->STM32F302_ADC1_2_CCR.All;
	STM32F302_ADC1_2_CCR.Bit.CKMODE = 1;
	pSTM32F302_ADC1_2->STM32F302_ADC1_2_CCR.All = STM32F302_ADC1_2_CCR.All;

	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADVREGEN = 0;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;

	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADVREGEN = 1;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;

	i = 10;
	while (i--) {
		ASM("NOP");
	}

	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADCALDIF = 0;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;


	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADCAL = 1;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;

 	while (1 == pSTM32F302_ADC1->STM32F302_ADC1_CR.Bit.ADCAL) {} //todo tiemeout

#if 0
 	STM32F302_ADC1_IER.All = 0;
 	//STM32F302_ADC1_IER.Bit.EOCIE = 1;
 	//STM32F302_ADC1_IER.Bit.ADRDYIE = 1;
 	pSTM32F302_ADC1->STM32F302_ADC1_IER.All = STM32F302_ADC1_IER.All;
#endif

	STM32F302_ADC1_CFGR.All = STM32F302_ADC1_CFGR_RESET_VALUE;
	STM32F302_ADC1_CFGR.Bit.DMAEN = 1;
	STM32F302_ADC1_CFGR.Bit.CONT = 1;
	STM32F302_ADC1_CFGR.Bit.DMACFG = 1;
	STM32F302_ADC1_CFGR.Bit.AUTDLY = 1; /* i use auto delay because there were OVR in combination with DMA */
	pSTM32F302_ADC1->STM32F302_ADC1_CFGR.All = STM32F302_ADC1_CFGR.All;

	STM32F302_ADC1_SQR1.All = STM32F302_ADC1_SQR1_RESET_VALUE;
	STM32F302_ADC1_SQR1.Bit.L = 1;
	STM32F302_ADC1_SQR1.Bit.SQ1 = 2;
	STM32F302_ADC1_SQR1.Bit.SQ2 = 3;
	STM32F302_ADC1_SQR1.Bit.SQ3 = 0;
	STM32F302_ADC1_SQR1.Bit.SQ4 = 0;
	pSTM32F302_ADC1->STM32F302_ADC1_SQR1.All = STM32F302_ADC1_SQR1.All;


	STM32F302_ADC1_SMPR1.All = STM32F302_ADC1_SMPR1_RESET_VALUE;
	STM32F302_ADC1_SMPR1.Bit.SMP1 = 7;
	STM32F302_ADC1_SMPR1.Bit.SMP2 = 7;
	pSTM32F302_ADC1->STM32F302_ADC1_SMPR1.All = STM32F302_ADC1_SMPR1.All;

	STM32F302_ADC1_SQR2.All = STM32F302_ADC1_SQR2_RESET_VALUE;
	STM32F302_ADC1_SQR2.Bit.SQ5 = 0;
	STM32F302_ADC1_SQR2.Bit.SQ6 = 0;
	STM32F302_ADC1_SQR2.Bit.SQ7 = 0;
	STM32F302_ADC1_SQR2.Bit.SQ8 = 0;
	STM32F302_ADC1_SQR2.Bit.SQ9 = 0;
	pSTM32F302_ADC1->STM32F302_ADC1_SQR2.All = STM32F302_ADC1_SQR2.All;

 	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADEN = 1;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;

 	while (0 == pSTM32F302_ADC1->STM32F302_ADC1_ISR.Bit.ADRDY) {} //todo tiemeout

	STM32F302_ADC1_CR.All = pSTM32F302_ADC1->STM32F302_ADC1_CR.All;
	STM32F302_ADC1_CR.Bit.ADSTART = 1;
	pSTM32F302_ADC1->STM32F302_ADC1_CR.All = STM32F302_ADC1_CR.All;
}
